---
import Layout from '../layouts/Layout.astro';
import type { Session } from '@auth/core/types';
import { Auth, Signin, Signout } from '../lib/components';
import { authOpts } from './api/auth/[...astroAuth]';

import _crypto from 'node:crypto'

// Prior to Node 19.0.0, we need the following polyfills
// This gives us at the very least support for Node ^17.4.0
// See: https://github.com/nextauthjs/next-auth/issues/6417#issuecomment-1384660656
// @ts-expect-error
if (typeof globalThis.crypto.subtle === "undefined") globalThis.crypto.subtle = _crypto.webcrypto.subtle
if (typeof globalThis.crypto.randomUUID === "undefined") globalThis.crypto.randomUUID = _crypto.randomUUID

console.log(crypto.subtle)
---

<Layout title="Welcome to Astro Auth">
  <Auth authOpts={authOpts}>
    {(session: Session) => 
      <main>
        <h1>Astro + AuthJS</h1>
        <p>
          <a href="/protected">Protected Route</a>
        </p>
        <Signin provider="github">Login</Signin>
        <Signout>Logout</Signout>
        <p>
          {session ? `Logged in as ${session.user?.name}` : 'Not logged in'}
        </p>
      </main>
    }
  </Auth>
</Layout>
